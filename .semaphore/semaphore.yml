version: v1.0
name: GogglesDb Engine
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

fail_fast:
  stop:
    when: 'true'

global_job_config:
  # Execute at the start of every job in the pipeline:
  prologue:
    commands:
      - checkout
      - mkdir -pv tmp
      - cache restore bundle-$(checksum Gemfile.lock)

blocks:
  - name: Bundle cache store
    task:
      jobs:
        - name: Bundle with cache store
          commands:
            - sem-version ruby 2.6.3
            # Force update to newest Bundler version:
            - gem i bundler
            # Don't store cache in between build pipelines:
            # - cache clear
            - bundle install
            - bundle info rake --path
            - cache store bundle-$(checksum Gemfile.lock) /home/semaphore/.rbenv/versions/2.6.3/lib/ruby/gems

  - name: Code scanning
    task:
      jobs:
        - name: check style + security
          commands:
            - sem-version ruby 2.6.3
            # Force update to newest Bundler version:
            - gem i bundler
            # Bundler requires 'install' to run even though cache has been restored.
            # Installation will not actually run and command will finish quickly:
            - bundle install
            - bundle exec rubocop
            - bundle exec brakeman -A6q -p spec/dummy

  - name: RSpec tests
    task:
      prologue:
        commands:
          - sem-version ruby 2.6.3
          - sem-service start mysql
          # Force update to newest Bundler version:
          - gem i bundler
          - bundle install
          - cp spec/dummy/config/database.semaphore_2.yml spec/dummy/config/database.yml
          - 'curl -L -o spec/dummy/db/dump/test.sql.bz2 "https://github.com/steveoro/goggles_admin/raw/master/db/dump/development.sql.bz2"'
          - 'RAILS_ENV=test bin/rails app:db:rebuild from=test to=test'
          - 'RAILS_ENV=test bin/rails db:migrate'
          - export CODECOV_TOKEN=$CODECOV_TOKEN_GOGGLES_DB
          - export CODECLIMATE_REPO_TOKEN=$CODECLIMATE_TOKEN_GOGGLES_DB
      jobs:
        - name: RSpec - models
          commands:
            - 'bundle exec rspec -t type:model'
            - bash <(curl -s https://codecov.io/bash) -cF model
            - bundle exec codeclimate-test-reporter

        - name: RSpec - strategies
          commands:
            - 'bundle exec rspec -t type:strategy'
            - bash <(curl -s https://codecov.io/bash) -cF strategy
            - bundle exec codeclimate-test-reporter

        - name: RSpec - validators
          commands:
            - 'bundle exec rspec -t type:validator'
            - bash <(curl -s https://codecov.io/bash) -cF validator
            - bundle exec codeclimate-test-reporter

        # Not currently used:
        # - name: RSpec - decorators
        #   commands:
        #     - 'bundle exec rspec -t type:decorator'
